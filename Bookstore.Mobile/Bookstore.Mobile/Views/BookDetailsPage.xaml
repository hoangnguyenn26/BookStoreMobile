<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Bookstore.Mobile.ViewModels"
             xmlns:dto_book="clr-namespace:Bookstore.Mobile.Models"
             x:DataType="vm:BookDetailsViewModel"
             x:Class="Bookstore.Mobile.Views.BookDetailsPage"
             Title="{Binding Title}">
    <!-- Title có thể là tên sách -->

    <ScrollView>
        <VerticalStackLayout Spacing="15" Padding="15">

            <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" HorizontalOptions="CenterAndExpand" />

            <Label Text="{Binding ErrorMessage}" Style="{StaticResource ErrorLabel}" IsVisible="{Binding HasError}"/>

            <VerticalStackLayout IsVisible="{Binding ShowContent}">

                <Image Source="{Binding BookDetails.CoverImageUrl, TargetNullValue='dotnet_bot.png', FallbackValue='dotnet_bot.png'}"
                       Aspect="AspectFit"
                       HeightRequest="300"
                       Margin="0,0,0,15"/>

                <Label Text="{Binding BookDetails.Title}" Style="{StaticResource Headline}" FontSize="Title" LineBreakMode="WordWrap"/>

                <Label FontSize="Medium" FontAttributes="Italic" TextColor="{StaticResource Gray600Light}">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="by "/>
                            <Span Text="{Binding BookDetails.Author.Name, TargetNullValue='Unknown Author'}"/>
                        </FormattedString>
                    </Label.FormattedText>
                </Label>

                <HorizontalStackLayout Spacing="10" Margin="0,10">
                    <Label Text="{Binding BookDetails.Price, StringFormat='{0:C}'}" FontSize="Large" FontAttributes="Bold" TextColor="{StaticResource PrimaryLight}" VerticalOptions="Center"/>
                    <Label Text="{Binding BookDetails.StockQuantity, StringFormat='({0} in stock)'}" FontSize="Small" TextColor="{Binding BookDetails.StockQuantity, Converter={StaticResource StockToColorConverter}}" VerticalOptions="Center"/>

                </HorizontalStackLayout>

                <Grid ColumnDefinitions="*, Auto" ColumnSpacing="10" Margin="0,10">
                    <Button Text="Add to Cart"
                            Grid.Column="0"
                            Command="{Binding AddToCartCommand}"
                            IsEnabled="{Binding CanAddToCart}"/>

                    <Button Grid.Column="1"
                            Command="{Binding ToggleWishlistCommand}"
                            IsEnabled="{Binding IsNotBusy}"
                            BackgroundColor="{StaticResource Transparent}"
                            BorderColor="{StaticResource PrimaryLight}"
                            BorderWidth="2"
                            Padding="10">
                        <Button.ImageSource>
                            <FontImageSource Glyph="{Binding IsInWishlist, Converter={StaticResource BoolToWishlistIconConverter}}"
                                              FontFamily="MaterialSymbolsRounded"
                                Color="{StaticResource PrimaryLight}"/>
                        </Button.ImageSource>
                    </Button>
                </Grid>

                <Label Text="Description" FontAttributes="Bold" FontSize="Medium" Margin="0,15,0,5"/>
                <Label Text="{Binding BookDetails.Description}" LineBreakMode="WordWrap" FontSize="Body"/>

                <Label Text="Details" FontAttributes="Bold" FontSize="Medium" Margin="0,15,0,5"/>
                <VerticalStackLayout BindableLayout.ItemsSource="{Binding BookDetailItems}" Spacing="5">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <HorizontalStackLayout Spacing="5">
                                <Label Text="{Binding Key}" FontAttributes="Bold" WidthRequest="120"/>
                                <Label Text="{Binding Value}" LineBreakMode="TailTruncation"/>
                            </HorizontalStackLayout>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>

            </VerticalStackLayout>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>